package com.example.lgfood_duan1.Activity;import androidx.annotation.NonNull;import androidx.appcompat.app.AppCompatActivity;import androidx.constraintlayout.widget.ConstraintLayout;import android.app.Dialog;import android.content.Intent;import android.content.SharedPreferences;import android.graphics.Color;import android.graphics.drawable.ColorDrawable;import android.net.Uri;import android.os.Build;import android.os.Bundle;import android.os.Handler;import android.view.View;import android.view.Window;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.TextView;import android.widget.Toast;import com.bumptech.glide.Glide;import com.example.lgfood_duan1.Model.model_Account;import com.example.lgfood_duan1.Model.model_SanPham;import com.example.lgfood_duan1.Model.model_admin;import com.example.lgfood_duan1.Model.model_hoaDon;import com.example.lgfood_duan1.R;import com.google.android.gms.tasks.OnFailureListener;import com.google.android.gms.tasks.OnSuccessListener;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.ValueEventListener;import com.google.firebase.storage.FirebaseStorage;import com.google.firebase.storage.StorageReference;import com.google.firebase.storage.UploadTask;import org.jetbrains.annotations.NotNull;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Date;import java.util.UUID;import de.hdodenhof.circleimageview.CircleImageView;public class thongTinTaiKhoan_Activity extends AppCompatActivity {    private TextView            ThongTinTaiKhoan_tv_tenTaiKhoan;    private ImageView            ThongTinTaiKhoan_img_btn_thoat,            ThongTinTaiKhoan_img_btn_chonAnh,            ThongTinTaiKhoan_img_vuongNiem,            ThongTinTaiKhoan_img_loaiThanhVien;    private ConstraintLayout            ThongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan,            ThongTinTaiKhoan_ctlou_btn_showThongKe,            ThongTinTaiKhoan_ctlou_btn_showCaiDat,            ThongTinTaiKhoan_ctlou_btn_showKhoHang,            ThongTinTaiKhoan_ctlou_btn_showDonHang,            ThongTinTaiKhoan_ctlou_btn_showQuanLyDonHang;    private LinearLayout ThongTinTaiKhoan_llout_admin;    private de.hdodenhof.circleimageview.CircleImageView            ThongTinTaiKhoan_Crimg_avatar;    private SharedPreferences shareAcout;    String idSharePre,idDonHang;    private DatabaseReference dataTaiKhoanRef;    private FirebaseDatabase dataTaiKhoan;    private FirebaseStorage storage;    private UploadTask uploadTask;    private StorageReference mountainImagesRef, storageRef;    private UUID uuid;    private model_Account listAccount;private ArrayList<model_hoaDon> arrListHoaDon;    private static final int REQUEST_IMAGE_OPEN = 99;    Uri full;    Dialog diaLog;    @Override    protected void onStart() {        super.onStart();        Handler handler=new Handler();        handler.postDelayed(new Runnable() {            @Override            public void run() {                diaLog.dismiss();            }        },3000);        diaLog.show();        super.onStart();    }    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_thong_tin_tai_khoan);        anhXa();        batSuKien();        getSharedPre();        getDataFirebase();        checkPhanQuyen();        checkCapDoThanhVien();    }//    check cấp độ thành viên    private void checkCapDoThanhVien(){        dataTaiKhoanRef = dataTaiKhoan.getReference("HoaDon").child(idDonHang);        dataTaiKhoanRef.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull @NotNull DataSnapshot snapshot) {                for (DataSnapshot child : snapshot.getChildren()) {                    model_hoaDon arrHoaDon = child.getValue(model_hoaDon.class);                    if (arrHoaDon.getTinhTrangDonHang() == 2){                    arrListHoaDon.add(arrHoaDon);                    }                }                if (arrListHoaDon.size() >=10) {                    ThongTinTaiKhoan_img_loaiThanhVien.setBackgroundResource(R.drawable.ic_thanhvienvang);                }else if (arrListHoaDon.size() >= 5 ){                    ThongTinTaiKhoan_img_loaiThanhVien.setBackgroundResource(R.drawable.ic_thanhvienbac);                }else{                    ThongTinTaiKhoan_img_loaiThanhVien.setBackgroundResource(R.drawable.ic_thanhviendong);                }            }            @Override            public void onCancelled(@NonNull @NotNull DatabaseError error) {            }        });    }    //    kiểm tra quyền của user    private void checkPhanQuyen() {        dataTaiKhoanRef = dataTaiKhoan.getReference("Admin");        dataTaiKhoanRef.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull @NotNull DataSnapshot snapshot) {                model_admin arrAdmin = snapshot.getValue(model_admin.class);                if (arrAdmin.getIdUser().equals(idSharePre)) {                    ThongTinTaiKhoan_llout_admin.setVisibility(View.VISIBLE);                    ThongTinTaiKhoan_img_vuongNiem.setVisibility(View.VISIBLE);                } else {                    ThongTinTaiKhoan_img_vuongNiem.setVisibility(View.INVISIBLE);                    ThongTinTaiKhoan_llout_admin.setVisibility(View.INVISIBLE);                }            }            @Override            public void onCancelled(@NonNull @NotNull DatabaseError error) {            }        });    }    private void setData(model_Account arrlist) {        Glide.with(thongTinTaiKhoan_Activity.this).load(arrlist.getAnhKhachHang())                .into(ThongTinTaiKhoan_Crimg_avatar);        ThongTinTaiKhoan_tv_tenTaiKhoan.setText(arrlist.getRealName());    }//        BT : getSharedPreFerences    private void getSharedPre() {        shareAcout = getSharedPreferences("USER_FILE", MODE_PRIVATE);        idSharePre = shareAcout.getString("IDUSRE", "");        idDonHang = shareAcout.getString("IDDANHSACHDONHANG","");    }    //    BT : getDataFirebase    private void getDataFirebase() {        dataTaiKhoanRef = dataTaiKhoan.getReference().child("Accounts").child(idSharePre);        dataTaiKhoanRef.addValueEventListener(new ValueEventListener() {            @Override            public void onDataChange(@NonNull DataSnapshot snapshot) {//                arrListSanPham.clear();//                Chạy vòng lặp kiểm tra dữ liệu                listAccount = snapshot.getValue(model_Account.class);                setData(listAccount);            }            @Override            public void onCancelled(DatabaseError error) {            }        });    }    //    BT : batSuKien    private void batSuKien() {//         chuyển đến trang thống kê        ThongTinTaiKhoan_ctlou_btn_showThongKe.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, quanLyDoanhThu_Activity.class);                startActivity(intent);            }        });//        ThongTinTaiKhoan_ctlou_btn_showDonHang        ThongTinTaiKhoan_ctlou_btn_showDonHang.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, donHangUser_Activity.class);                startActivity(intent);            }        });//        Trung thoát trang        ThongTinTaiKhoan_img_btn_thoat.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, trangChu_SanPham_Activity.class);                startActivity(intent);            }        });// Trung Mở Quản lý kho hàng        ThongTinTaiKhoan_ctlou_btn_showKhoHang.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, khoHang_Activity.class);                startActivity(intent);            }        });        // chuyển trang quản lý đơn hàng        ThongTinTaiKhoan_ctlou_btn_showQuanLyDonHang.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, xac_Nhan_Don_hang_Activity.class);                startActivity(intent);            }        });//        chuyển sang trang đăng kí tài khoản        ThongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Bundle bundle = new Bundle();                bundle.putString("idUser", listAccount.getId());                bundle.putString("realNameUse", listAccount.getRealName());                bundle.putString("nameUser", listAccount.getName());                bundle.putString("passWordUser", listAccount.getPassword());                bundle.putString("addRessUser", listAccount.getAddress());                bundle.putString("emailUser", listAccount.getEmail());                bundle.putString("phoneNumberUser", listAccount.getPhoneNumber());                bundle.putString("mIdGioHang", listAccount.getIdGioHang());                bundle.putString("mAnhKhachHang", listAccount.getAnhKhachHang());                Intent intent = new Intent(thongTinTaiKhoan_Activity.this, Chinh_Sua_Thong_Tin_Accounts_Activity.class);                intent.putExtras(bundle);                startActivity(intent);                Toast.makeText(thongTinTaiKhoan_Activity.this, "" + listAccount.getName(), Toast.LENGTH_SHORT).show();            }        });//        mở thư viện ảnh        ThongTinTaiKhoan_img_btn_chonAnh.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                moFileThuMucAnh();            }        });    }    // BT: mở thư viện ảnh    private void moFileThuMucAnh() {        anhXa();        Intent intent = new Intent(Intent.ACTION_GET_CONTENT);        intent.setType("image/*");        intent.addCategory(Intent.CATEGORY_OPENABLE);        startActivityForResult(intent, REQUEST_IMAGE_OPEN);    }    // lấy ảnh trong thư viện và show anh lên imgview    @Override    protected void onActivityResult(int requestCode, int resultCode, Intent data) {        //  bắt sự kiến khi nhấn lưu ảnh thỉ gán vào imgview        if (requestCode == REQUEST_IMAGE_OPEN && resultCode == RESULT_OK && data != null && data.getData() != null) {            full = data.getData();            ThongTinTaiKhoan_Crimg_avatar.setImageURI(full);            storageRef = storage.getReference();            mountainImagesRef = storageRef.child("images/ProFile/" + new Date().getTime() + ".jpg");            uploadTask = mountainImagesRef.putFile(full);            //  kiếm tra            //  nếu lỗi file chạy vào đây            uploadTask.addOnFailureListener(new OnFailureListener() {                @Override                public void onFailure(Exception e) {                    Toast.makeText(thongTinTaiKhoan_Activity.this, "Lưu ảnh thất bại", Toast.LENGTH_SHORT).show();                }                //     add file thành công            }).addOnSuccessListener(new OnSuccessListener<UploadTask.TaskSnapshot>() {                @Override                public void onSuccess(UploadTask.TaskSnapshot taskSnapshot) {                    //    khởi tạo link url                    mountainImagesRef.getDownloadUrl().addOnSuccessListener(new OnSuccessListener<Uri>() {                        @Override                        public void onSuccess(Uri uri) {                            // datetime hiện tại//                        //      myRef chỉ con trỏ tại vị trí ""                            dataTaiKhoanRef = dataTaiKhoan.getReference("Accounts").child(idSharePre);////                        //      kiểm tra điều kiện nếu như có ảnh trên storage thì lưu có định dạng không thì rỗng//                            dataTaiKhoanRef.child("anhKhachHang").setValue(uri.toString());//                        //        add giá trị                            dataTaiKhoanRef.child(listAccount.getId().toString()).setValue(listAccount);                            Toast.makeText(thongTinTaiKhoan_Activity.this, "Thêm thành công", Toast.LENGTH_SHORT).show();                        }                    });                }            });        }        super.onActivityResult(requestCode, resultCode, data);    }    //    BT : ánh xạ    private void anhXa() {        diaLog = new Dialog(thongTinTaiKhoan_Activity.this);        diaLog.requestWindowFeature(Window.FEATURE_NO_TITLE);        diaLog.setContentView(R.layout.item_login);        diaLog.getWindow().setBackgroundDrawable(new ColorDrawable(Color.TRANSPARENT));//Model        arrListHoaDon= new ArrayList<>();        //    Firebase        dataTaiKhoan = FirebaseDatabase.getInstance("https://duan-lgfood1-default-rtdb.asia-southeast1.firebasedatabase.app/");        //    FirebaseStorage        storage = FirebaseStorage.getInstance("gs://duan1-lgfood.appspot.com");//LinearLayout        ThongTinTaiKhoan_llout_admin = findViewById(R.id.thongTinTaiKhoan_llout_admin);//    CircleImageView        ThongTinTaiKhoan_Crimg_avatar = findViewById(R.id.thongTinTaiKhoan_Crimg_avatar);//    TextView        ThongTinTaiKhoan_tv_tenTaiKhoan = findViewById(R.id.thongTinTaiKhoan_tv_tenTaiKhoan);//    ImageView        ThongTinTaiKhoan_img_btn_thoat = findViewById(R.id.thongTinTaiKhoan_img_btn_thoat);        ThongTinTaiKhoan_img_btn_chonAnh = findViewById(R.id.thongTinTaiKhoan_img_btn_chonAnh);        ThongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan);        ThongTinTaiKhoan_ctlou_btn_showThongKe = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showThongKe);        ThongTinTaiKhoan_ctlou_btn_showCaiDat = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showCaiDat);        ThongTinTaiKhoan_img_vuongNiem = findViewById(R.id.thongTinTaiKhoan_img_vuongNiem);        ThongTinTaiKhoan_img_loaiThanhVien = findViewById(R.id.thongTinTaiKhoan_img_loaiThanhVien);//        ConstraintLayout        ThongTinTaiKhoan_ctlou_btn_showKhoHang = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showKhoHang);        ThongTinTaiKhoan_ctlou_btn_showDonHang = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showDonHang);        ThongTinTaiKhoan_ctlou_btn_showQuanLyDonHang = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showQuanLyDonHang);        ThongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showThongTinTaiKhoan);        ThongTinTaiKhoan_ctlou_btn_showThongKe = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showThongKe);        ThongTinTaiKhoan_ctlou_btn_showCaiDat = findViewById(R.id.thongTinTaiKhoan_ctlou_btn_showCaiDat);    }}